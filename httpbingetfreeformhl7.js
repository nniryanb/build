// Author @iryanb Noname Security 1.13.2023 
// For Intel Phantom Lake nn ML performance benchmarking purposes

import http from 'k6/http';
import { check, sleep } from 'k6';
import crypto from "k6/crypto";
import encoding from "k6/encoding";

const algToHash = {
    HS256: "sha256",
    HS384: "sha384",
    HS512: "sha512"
};


export let options = {

  stages: [
    { duration: '11s', target: 1000 },
    { duration: '59m', target: 1000 },
    { duration: '49s', target: 1000 },
  ],
};


function sign(data, hashAlg, secret) {
    let hasher = crypto.createHMAC(hashAlg, secret);
    hasher.update(data);

    // Some manual base64 rawurl encoding as `Hasher.digest(encodingType)`
    // doesn't support that encoding type yet.
    return hasher.digest("base64").replace(/\//g, "_").replace(/\+/g, "-").replace(/=/g, "");
}

function encode(payload, secret, algorithm) {
    algorithm = algorithm || "HS256";
    let header = encoding.b64encode(JSON.stringify({ typ: "JWT", alg: algorithm }), "rawurl");
    payload = encoding.b64encode(JSON.stringify(payload), "rawurl");
    let sig = sign(header + "." + payload, algToHash[algorithm], secret);
    return [header, payload, sig].join(".");
}

function decode(token, secret, algorithm) {
    let parts = token.split('.');
    let header = JSON.parse(encoding.b64decode(parts[0], "rawurl"));
    let payload = JSON.parse(encoding.b64decode(parts[1], "rawurl"));
    algorithm = algorithm || algToHash[header.alg];
    if (sign(parts[0] + "." + parts[1], algorithm, secret) != parts[2]) {
        throw Error("JWT signature verification failed");
    }
    return payload;
}

export default function () {
  //replace the subkey value with the API Subscription Key qp value authorized by this api gateway 
  // const subkey = 'changethis'
  //replace the gwhost value with the hostname of the api gateway 

  const gwhost = '172.31.25.74:9980';
  const email = `nn0${__VU}@noname.net`;
  
    let tokenfor = { email : email };
    let JWT = encode(tokenfor, `secret${__VU}`);
   // console.log("encoded", JWT);

  const params = { headers: { 'Ocp-Apim-Subscription-Key':'mockapikeythisapihasnogwapim', 'Content-Type': 'application/json', 'Authorization':'Bearer '+JWT } };
  let hl7fhir = '{"resourceType":"Bundle","id":"c2b1bd8d-5eb5-468f-9089-b3ad89e05c49","meta":{"lastUpdated":"2022-10-05T02:14:26.456+00:00"},"type":"searchset","link":[{"relation":"self","url":"https://hapi.fhir.org/baseR4/Patient?_format=json&_pretty=true"},{"relation":"next","url":"https://hapi.fhir.org/baseR4?_getpages=c2b1bd8d-5eb5-468f-9089-b3ad89e05c49&_getpagesoffset=20&_count=20&_format=json&_pretty=true&_bundletype=searchset"}],"entry":[{"fullUrl":"https://hapi.fhir.org/baseR4/Patient/6970256","resource":{"resourceType":"Patient","id":"6970256","meta":{"versionId":"1","lastUpdated":"2022-08-31T14:35:57.629+00:00","source":"#9dXtK71pRBkUNOAH","profile":["http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"]},"text":{"status":"generated","div":"<div xmlns=\"http://www.w3.org/1999/xhtml\"><div class=\"hapiHeaderText\"/><table class=\"hapiPropertyTable\"><tbody><tr><td>Identifier</td><td>50050329</td></tr><tr><td>Address</td><td><span>TR </span></td></tr><tr><td>Date of birth</td><td><span>26 September 1936</span></td></tr></tbody></table></div>"},"identifier":[{"value":"50050329"}],"name":[{"text":"NoName"}],"gender":"male","birthDate":"1936-09-26","address":[{"country":"TR"}]},"search":{"mode":"match"}},{"fullUrl":"https://hapi.fhir.org/baseR4/Patient/6970257","resource":{"resourceType":"Patient","id":"6970257","meta":{"versionId":"1","lastUpdated":"2022-08-31T14:35:57.768+00:00","source":"#9dXtK71pRBkUNOAH","profile":["http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"]},"text":{"status":"generated","div":"<div xmlns=\"http://www.w3.org/1999/xhtml\"><div class=\"hapiHeaderText\"/><table class=\"hapiPropertyTable\"><tbody><tr><td>Identifier</td><td>50050331</td></tr><tr><td>Address</td><td><span>IT </span></td></tr><tr><td>Date of birth</td><td><span>23 December 1919</span></td></tr></tbody></table></div>"},"identifier":[{"value":"50050331"}],"name":[{"text":"NoName"}],"gender":"male","birthDate":"1919-12-23","address":[{"country":"IT"}]},"search":{"mode":"match"}},{"fullUrl":"https://hapi.fhir.org/baseR4/Patient/6970258","resource":{"resourceType":"Patient","id":"6970258","meta":{"versionId":"1","lastUpdated":"2022-08-31T14:35:57.829+00:00","source":"#9dXtK71pRBkUNOAH","profile":["http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"]},"text":{"status":"generated","div":"<div xmlns=\"http://www.w3.org/1999/xhtml\"><div class=\"hapiHeaderText\"/><table class=\"hapiPropertyTable\"><tbody><tr><td>Identifier</td><td>50050339</td></tr><tr><td>Address</td><td><span>DE </span></td></tr><tr><td>Date of birth</td><td><span>14 March 1926</span></td></tr></tbody></table></div>"},"identifier":[{"value":"50050339"}],"name":[{"text":"NoName"}],"gender":"male","birthDate":"1926-03-14","address":[{"country":"DE"}]},"search":{"mode":"match"}},{"fullUrl":"https://hapi.fhir.org/baseR4/Patient/6970259","resource":{"resourceType":"Patient","id":"6970259","meta":{"versionId":"1","lastUpdated":"2022-08-31T14:35:58.074+00:00","source":"#9dXtK71pRBkUNOAH","profile":["http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"]},"text":{"status":"generated","div":"<div xmlns=\"http://www.w3.org/1999/xhtml\"><div class=\"hapiHeaderText\"/><table class=\"hapiPropertyTable\"><tbody><tr><td>Identifier</td><td>50050355</td></tr><tr><td>Address</td><td><span>USA </span></td></tr><tr><td>Date of birth</td><td><span>06 February 1920</span></td></tr></tbody></table></div>"},"identifier":[{"value":"50050355"}],"name":[{"text":"NoName"}],"gender":"male","birthDate":"1920-02-06","address":[{"country":"USA"}]},"search":{"mode":"match"}},{"fullUrl":"https://hapi.fhir.org/baseR4/Patient/6970260","resource":{"resourceType":"Patient","id":"6970260","meta":{"versionId":"1","lastUpdated":"2022-08-31T14:35:58.339+00:00","source":"#9dXtK71pRBkUNOAH","profile":["http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"]},"text":{"status":"generated","div":"<div xmlns=\"http://www.w3.org/1999/xhtml\"><div class=\"hapiHeaderText\"/><table class=\"hapiPropertyTable\"><tbody><tr><td>Identifier</td><td>50100206</td></tr><tr><td>Address</td><td><span>FR </span></td></tr><tr><td>Date of birth</td><td><span>28 February 1920</span></td></tr></tbody></table></div>"},"identifier":[{"value":"50100206"}],"name":[{"text":"NoName"}],"gender":"male","birthDate":"1920-02-28","address":[{"country":"FR"}]},"search":{"mode":"match"}},{"fullUrl":"https://hapi.fhir.org/baseR4/Patient/6970261","resource":{"resourceType":"Patient","id":"6970261","meta":{"versionId":"1","lastUpdated":"2022-08-31T14:35:58.479+00:00","source":"#9dXtK71pRBkUNOAH","profile":["http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"]},"text":{"status":"generated","div":"<div xmlns=\"http://www.w3.org/1999/xhtml\"><div class=\"hapiHeaderText\"/><table class=\"hapiPropertyTable\"><tbody><tr><td>Identifier</td><td>50100484</td></tr><tr><td>Address</td><td><span>TR </span></td></tr><tr><td>Date of birth</td><td><span>19 June 1925</span></td></tr></tbody></table></div>"},"identifier":[{"value":"50100484"}],"name":[{"text":"NoName"}],"gender":"male","birthDate":"1925-06-19","address":[{"country":"TR"}]},"search":{"mode":"match"}},{"fullUrl":"https://hapi.fhir.org/baseR4/Patient/6970262","resource":{"resourceType":"Patient","id":"6970262","meta":{"versionId":"1","lastUpdated":"2022-08-31T14:35:58.573+00:00","source":"#9dXtK71pRBkUNOAH","profile":["http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"]},"text":{"status":"generated","div":"<div xmlns=\"http://www.w3.org/1999/xhtml\"><div class=\"hapiHeaderText\"/><table class=\"hapiPropertyTable\"><tbody><tr><td>Identifier</td><td>50100487</td></tr><tr><td>Address</td><td><span>NL </span></td></tr><tr><td>Date of birth</td><td><span>15 December 1919</span></td></tr></tbody></table></div>"},"identifier":[{"value":"50100487"}],"name":[{"text":"NoName"}],"gender":"male","birthDate":"1919-12-15","address":[{"country":"NL"}]},"search":{"mode":"match"}},{"fullUrl":"https://hapi.fhir.org/baseR4/Patient/6970263","resource":{"resourceType":"Patient","id":"6970263","meta":{"versionId":"1","lastUpdated":"2022-08-31T14:35:58.672+00:00","source":"#9dXtK71pRBkUNOAH","profile":["http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"]},"text":{"status":"generated","div":"<div xmlns=\"http://www.w3.org/1999/xhtml\"><div class=\"hapiHeaderText\"/><table class=\"hapiPropertyTable\"><tbody><tr><td>Identifier</td><td>50100494</td></tr><tr><td>Address</td><td><span>TR </span></td></tr><tr><td>Date of birth</td><td><span>18 December 1928</span></td></tr></tbody></table></div>"},"identifier":[{"value":"50100494"}],"name":[{"text":"NoName"}],"gender":"male","birthDate":"1928-12-18","address":[{"country":"TR"}]},"search":{"mode":"match"}},{"fullUrl":"https://hapi.fhir.org/baseR4/Patient/6970264","resource":{"resourceType":"Patient","id":"6970264","meta":{"versionId":"1","lastUpdated":"2022-08-31T14:35:58.792+00:00","source":"#9dXtK71pRBkUNOAH","profile":["http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"]},"text":{"status":"generated","div":"<div xmlns=\"http://www.w3.org/1999/xhtml\"><div class=\"hapiHeaderText\"/><table class=\"hapiPropertyTable\"><tbody><tr><td>Identifier</td><td>50100523</td></tr><tr><td>Address</td><td><span>IT </span></td></tr><tr><td>Date of birth</td><td><span>08 March 1934</span></td></tr></tbody></table></div>"},"identifier":[{"value":"50100523"}],"name":[{"text":"NoName"}],"gender":"male","birthDate":"1934-03-08","address":[{"country":"IT"}]},"search":{"mode":"match"}},{"fullUrl":"https://hapi.fhir.org/baseR4/Patient/6970265","resource":{"resourceType":"Patient","id":"6970265","meta":{"versionId":"1","lastUpdated":"2022-08-31T14:35:58.871+00:00","source":"#9dXtK71pRBkUNOAH","profile":["http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"]},"text":{"status":"generated","div":"<div xmlns=\"http://www.w3.org/1999/xhtml\"><div class=\"hapiHeaderText\"/><table class=\"hapiPropertyTable\"><tbody><tr><td>Identifier</td><td>50100524</td></tr><tr><td>Address</td><td><span>DE </span></td></tr><tr><td>Date of birth</td><td><span>09 October 1917</span></td></tr></tbody></table></div>"},"identifier":[{"value":"50100524"}],"name":[{"text":"NoName"}],"gender":"male","birthDate":"1917-10-09","address":[{"country":"DE"}]},"search":{"mode":"match"}},{"fullUrl":"https://hapi.fhir.org/baseR4/Patient/6970266","resource":{"resourceType":"Patient","id":"6970266","meta":{"versionId":"1","lastUpdated":"2022-08-31T14:35:59.103+00:00","source":"#9dXtK71pRBkUNOAH","profile":["http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"]},"text":{"status":"generated","div":"<div xmlns=\"http://www.w3.org/1999/xhtml\"><div class=\"hapiHeaderText\"/><table class=\"hapiPropertyTable\"><tbody><tr><td>Identifier</td><td>50100528</td></tr><tr><td>Address</td><td><span>USA </span></td></tr><tr><td>Date of birth</td><td><span>14 December 1933</span></td></tr></tbody></table></div>"},"identifier":[{"value":"50100528"}],"name":[{"text":"NoName"}],"gender":"male","birthDate":"1933-12-14","address":[{"country":"USA"}]},"search":{"mode":"match"}},{"fullUrl":"https://hapi.fhir.org/baseR4/Patient/6970267","resource":{"resourceType":"Patient","id":"6970267","meta":{"versionId":"1","lastUpdated":"2022-08-31T14:35:59.222+00:00","source":"#9dXtK71pRBkUNOAH","profile":["http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"]},"text":{"status":"generated","div":"<div xmlns=\"http://www.w3.org/1999/xhtml\"><div class=\"hapiHeaderText\"/><table class=\"hapiPropertyTable\"><tbody><tr><td>Identifier</td><td>50100533</td></tr><tr><td>Address</td><td><span>TR </span></td></tr><tr><td>Date of birth</td><td><span>28 June 1928</span></td></tr></tbody></table></div>"},"identifier":[{"value":"50100533"}],"name":[{"text":"NoName"}],"gender":"male","birthDate":"1928-06-28","address":[{"country":"TR"}]},"search":{"mode":"match"}},{"fullUrl":"https://hapi.fhir.org/baseR4/Patient/6970268","resource":{"resourceType":"Patient","id":"6970268","meta":{"versionId":"1","lastUpdated":"2022-08-31T14:35:59.389+00:00","source":"#9dXtK71pRBkUNOAH","profile":["http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"]},"text":{"status":"generated","div":"<div xmlns=\"http://www.w3.org/1999/xhtml\"><div class=\"hapiHeaderText\"/><table class=\"hapiPropertyTable\"><tbody><tr><td>Identifier</td><td>50100574</td></tr><tr><td>Address</td><td><span>NL </span></td></tr><tr><td>Date of birth</td><td><span>29 November 1915</span></td></tr></tbody></table></div>"},"identifier":[{"value":"50100574"}],"name":[{"text":"NoName"}],"gender":"male","birthDate":"1915-11-29","address":[{"country":"NL"}]},"search":{"mode":"match"}},{"fullUrl":"https://hapi.fhir.org/baseR4/Patient/6970269","resource":{"resourceType":"Patient","id":"6970269","meta":{"versionId":"1","lastUpdated":"2022-08-31T14:35:59.481+00:00","source":"#9dXtK71pRBkUNOAH","profile":["http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"]},"text":{"status":"generated","div":"<div xmlns=\"http://www.w3.org/1999/xhtml\"><div class=\"hapiHeaderText\"/><table class=\"hapiPropertyTable\"><tbody><tr><td>Identifier</td><td>50100588</td></tr><tr><td>Address</td><td><span>TR </span></td></tr><tr><td>Date of birth</td><td><span>01 August 1922</span></td></tr></tbody></table></div>"},"identifier":[{"value":"50100588"}],"name":[{"text":"NoName"}],"gender":"male","birthDate":"1922-08-01","address":[{"country":"TR"}]},"search":{"mode":"match"}},{"fullUrl":"https://hapi.fhir.org/baseR4/Patient/6970270","resource":{"resourceType":"Patient","id":"6970270","meta":{"versionId":"1","lastUpdated":"2022-08-31T14:35:59.543+00:00","source":"#9dXtK71pRBkUNOAH","profile":["http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"]},"text":{"status":"generated","div":"<div xmlns=\"http://www.w3.org/1999/xhtml\"><div class=\"hapiHeaderText\"/><table class=\"hapiPropertyTable\"><tbody><tr><td>Identifier</td><td>50100590</td></tr><tr><td>Address</td><td><span>IT </span></td></tr><tr><td>Date of birth</td><td><span>15 March 1933</span></td></tr></tbody></table></div>"},"identifier":[{"value":"50100590"}],"name":[{"text":"NoName"}],"gender":"male","birthDate":"1933-03-15","address":[{"country":"IT"}]},"search":{"mode":"match"}},{"fullUrl":"https://hapi.fhir.org/baseR4/Patient/6970271","resource":{"resourceType":"Patient","id":"6970271","meta":{"versionId":"1","lastUpdated":"2022-08-31T14:35:59.760+00:00","source":"#9dXtK71pRBkUNOAH","profile":["http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"]},"text":{"status":"generated","div":"<div xmlns=\"http://www.w3.org/1999/xhtml\"><div class=\"hapiHeaderText\"/><table class=\"hapiPropertyTable\"><tbody><tr><td>Identifier</td><td>50100600</td></tr><tr><td>Address</td><td><span>DE </span></td></tr><tr><td>Date of birth</td><td><span>06 October 1928</span></td></tr></tbody></table></div>"},"identifier":[{"value":"50100600"}],"name":[{"text":"NoName"}],"gender":"male","birthDate":"1928-10-06","address":[{"country":"DE"}]},"search":{"mode":"match"}},{"fullUrl":"https://hapi.fhir.org/baseR4/Patient/6970272","resource":{"resourceType":"Patient","id":"6970272","meta":{"versionId":"1","lastUpdated":"2022-08-31T14:35:59.925+00:00","source":"#9dXtK71pRBkUNOAH","profile":["http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"]},"text":{"status":"generated","div":"<div xmlns=\"http://www.w3.org/1999/xhtml\"><div class=\"hapiHeaderText\"/><table class=\"hapiPropertyTable\"><tbody><tr><td>Identifier</td><td>50100606</td></tr><tr><td>Address</td><td><span>USA </span></td></tr><tr><td>Date of birth</td><td><span>23 April 1920</span></td></tr></tbody></table></div>"},"identifier":[{"value":"50100606"}],"name":[{"text":"NoName"}],"gender":"male","birthDate":"1920-04-23","address":[{"country":"USA"}]},"search":{"mode":"match"}},{"fullUrl":"https://hapi.fhir.org/baseR4/Patient/6970273","resource":{"resourceType":"Patient","id":"6970273","meta":{"versionId":"1","lastUpdated":"2022-08-31T14:36:00.072+00:00","source":"#9dXtK71pRBkUNOAH","profile":["http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"]},"text":{"status":"generated","div":"<div xmlns=\"http://www.w3.org/1999/xhtml\"><div class=\"hapiHeaderText\"/><table class=\"hapiPropertyTable\"><tbody><tr><td>Identifier</td><td>50100607</td></tr><tr><td>Address</td><td><span>FR </span></td></tr><tr><td>Date of birth</td><td><span>31 August 1921</span></td></tr></tbody></table></div>"},"identifier":[{"value":"50100607"}],"name":[{"text":"NoName"}],"gender":"male","birthDate":"1921-08-31","address":[{"country":"FR"}]},"search":{"mode":"match"}},{"fullUrl":"https://hapi.fhir.org/baseR4/Patient/6970274","resource":{"resourceType":"Patient","id":"6970274","meta":{"versionId":"1","lastUpdated":"2022-08-31T14:36:00.187+00:00","source":"#9dXtK71pRBkUNOAH","profile":["http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"]},"text":{"status":"generated","div":"<div xmlns=\"http://www.w3.org/1999/xhtml\"><div class=\"hapiHeaderText\"/><table class=\"hapiPropertyTable\"><tbody><tr><td>Identifier</td><td>50100623</td></tr><tr><td>Address</td><td><span>TR </span></td></tr><tr><td>Date of birth</td><td><span>01 December 1933</span></td></tr></tbody></table></div>"},"identifier":[{"value":"50100623"}],"name":[{"text":"NoName"}],"gender":"male","birthDate":"1933-12-01","address":[{"country":"TR"}]},"search":{"mode":"match"}},{"fullUrl":"https://hapi.fhir.org/baseR4/Patient/6970275","resource":{"resourceType":"Patient","id":"6970275","meta":{"versionId":"1","lastUpdated":"2022-08-31T14:36:00.311+00:00","source":"#9dXtK71pRBkUNOAH","profile":["http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"]},"text":{"status":"generated","div":"<div xmlns=\"http://www.w3.org/1999/xhtml\"><div class=\"hapiHeaderText\"/><table class=\"hapiPropertyTable\"><tbody><tr><td>Identifier</td><td>50100642</td></tr><tr><td>Address</td><td><span>NL </span></td></tr><tr><td>Date of birth</td><td><span>03 June 1918</span></td></tr></tbody></table></div>"},"identifier":[{"value":"50100642"}],"name":[{"text":"NoName"}],"gender":"male","birthDate":"1918-06-03","address":[{"country":"NL"}]},"search":{"mode":"match"}}]}';
  let res = http.get('http://'+gwhost+'/get?freeform='+hl7fhir, params);

  check(res, { 'status was 200': (r) => r.status == 200 });
 // console.log(JSON.stringify(res));
  sleep(1);
}

